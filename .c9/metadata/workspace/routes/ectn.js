{"filter":false,"title":"ectn.js","tooltip":"/routes/ectn.js","undoManager":{"mark":10,"position":10,"stack":[[{"start":{"row":0,"column":0},"end":{"row":350,"column":0},"action":"insert","lines":["const router = require(\"express\").Router();","const Clients = require(\"../models/client\");","const Cargos = require(\"../models/cargo\");","const async = require('async');","const moment = require('moment');","","","","","","","//CONSIGNEE","router.get('/cargo', function(req, res) {","    if (req.user) {","        //get clients","","        async.parallel([","","            function(callback) {","                Clients.find({}, function(err, foundData) {","                    callback(err, foundData);","                });","            },","            function(callback) {","                Cargos.find({})","                    .populate(\"Client\")","                    .sort('-Client')","                    .exec(function(err, foundData) {","                        callback(err, foundData);","                    });","            }","","        ], (err, results) => {","            var clientsData = results[0];","            var CargoData = results[1];","            return res.render(\"main/cargo\", { title: 'Oldsailor Ocean Shipping LLC || Cargo', clientsData: clientsData, CargoData: CargoData });","        });","","    }","    else {","        return res.redirect('/login');","    }","});","","","","//CONSIGNEE","router.get('/cargo/displaynewcargo', function(req, res) {","    if (req.user) {","        //get clients","","        async.parallel([","","            function(callback) {","                Clients.find({}).sort('-_id').exec(function(err, foundData) {","                    callback(err, foundData);","                });","            }","","        ], (err, results) => {","            var clientsData = results[0];","            return res.render(\"main/newCargo\", { title: 'Oldsailor Ocean Shipping LLC || New Cargo', clientsData: clientsData, layout: false });","        });","","    }","    else {","        return res.redirect('/login');","    }","});","","","","//check per day","router.get(\"/checkcargourl__/:id\", function(req, res) {","    //  console.log(req.params.id);","    var date = new Date();","    date.setHours(0, 0, 0, 0)","    //console.log(date)","","    Cargos.findOne({ createdAt: date, Client: req.params.id }, function(err, foundData) {","        if (foundData) {","            //       console.log(\"here\")","            return res.send(foundData._id);","        }","        else {","            return res.send(\"\");","        }","","    });","});","","","","","router.post(\"/cargo/new\", function(req, res) {","    //check if cargo exist ","    //   var vin = \"\";","    var car = undefined;","    // if (req.body.data.vin !== \"\") {","    //     vin = req.body.data.vin;","    // }","","    if (req.body.data.cardetails !== \"\") {","        car = {","            vin: req.body.data.vin,","            aes: req.body.data.aes,","            cardetails: req.body.data.cardetails,","","","        }","    }","","","","    if (req.body.data.cargo_id === \"\") {","        //cargo does not exist add","","        var newData = {","            createdAt: moment.parseZone(new Date()).format('l'),","            Cars: car,","            Client: req.body.data.client_ID,","            personal_effect: req.body.data.personal_effect","        };","","        //add","        Cargos.create(newData, function(err, newlyCreated) {","            // console.log(newlyCreated);","            return res.send(newlyCreated);","        });","    }","    else {","        //cargo exist update","","        async.parallel([","            function(callback) {","                //update personal effect","                Cargos.findByIdAndUpdate(req.body.data.cargo_id, { personal_effect: req.body.data.personal_effect },","                    function(err, updatedData) {","                        callback(err, updatedData);","                    });","            },","            function(callback) {","                //push new cars into the array","                Cargos.findOne({ _id: req.body.data.cargo_id },","                    function(err, cargos) {","                        cargos.Cars.push(car);","                        cargos.save();","                        callback(err, cargos);","                    });","            }","        ], function(err, results) {","            var result1 = results[0];","            var cars = results[1];","            //console.log(result1.personal_effect);","            console.log(cars.Cars);","            return res.send(result1);","        });","","","    }","});","","","","//Add More Cars","router.post(\"/cargo/:id/addmorecars\", function(req, res) {","    //check if cargo exist ","    // var vin = \"\";","    // if (req.body.data.vin !== \"\") {","    //     vin = \"VIN:\" + req.body.data.vin;","    // }","","    //check for cardetails","","    var car = {","        vin: req.body.data.vin,","        aes: req.body.data.aes,","        cardetails: req.body.data.cardetails,","","","    }","    //update Cars Array","    //push new cars into the array","    Cargos.findOne({ _id: req.params.id },","        function(err, cargos) {","","            //check if there is a car before pushing","            if (req.body.data.cardetails !== \"\") {","                cargos.Cars.push(car);","                cargos.save();","                return res.send(cargos);","            }","            else {","                return res.send(false);","            }","","","        });","","});","","","//Fetch Cargo per client by name","router.get(\"/cargo/:value/fetchCargo_perclient\", function(req, res) {","    if (\"Display cargo per client\" === req.params.value) {","        Cargos","            .find({})","            .populate(\"Client\")","            .exec(function(err, foundAllData) {","                return res.send(foundAllData)","            });","","    }","    else {","        //get that clients cargos","","","        // console.log();","        Cargos","            .find({ Client: req.params.value })","            .populate('Client')","            .exec(function(err, foundData) {","                // console.log(foundData);","                return res.send(foundData)","","            });","","","    }","});","","","","//display one cargo","router.get('/cargo/:id/oneCargo', function(req, res) {","    if (req.user) {","        Cargos.findOne({ _id: req.params.id })","            .populate(\"Client\")","            .exec(function(err, foundData) {","                //console.log(foundData);","                res.send(foundData);","            });","","    }","    else {","        return res.redirect('/login');","    }","});","","","//display edit cargo route","router.get('/cargo/:id/editRoute', function(req, res) {","    if (req.user) {","        Cargos.findOne({ _id: req.params.id })","            .populate(\"Client\")","            .exec(function(err, foundData) {","                //console.log(foundData);","                res.render(\"main/editCargo\", { layout: false, foundData: foundData });","            });","","    }","    else {","        return res.redirect('/login');","    }","});","","//edit car post route","router.post(\"/cargo/:cargo_id/edit\", function(req, res) {","    Cargos.update({","            _id: req.params.cargo_id,","            Cars: { $elemMatch: { _id: req.body.data.car_id } }","        },","","        {","            $set: {","                \"Cars.$.cardetails\": req.body.data.cardetails,","                \"Cars.$.aes\": req.body.data.aes,","                \"Cars.$.vin\": req.body.data.vin","            },","","","        }, {","            \"multi\": true","","        },","        function(err, updated) {","            // console.log(updated)","            return res.send(updated)","        });","});","","//edit personal effect","router.post(\"/cargo/:cargo_id/edit_personaleffect\", function(req, res) {","    Cargos.findByIdAndUpdate(req.params.cargo_id, { personal_effect: req.body.data.personal_effect }, function(err, updatedData) {","        res.send(updatedData);","    });","});","","","//delete cargo","router.delete(\"/cargo/:id/delete\", function(req, res) {","    Cargos.findByIdAndRemove(req.params.id, function(err) {","        if (err)","            return console.log(err);","        else","            return res.send(req.params.id);","    })","","});","","","//delete Car","router.post(\"/cars/:car_id/delete/:cargo_id\", function(req, res) {","    Cargos.update({","            _id: req.params.cargo_id","","        }, {","            \"$pull\": {","                \"Cars\": {","                    \"_id\": req.params.car_id","                }","            }","        },","","        {","            safe: true,","            multi: true","        },","        function(err, updated) {","            // console.log(updated);","            res.send(updated)","        });","    // console.log(req.params.car_id);","});","","","","","","// Cargos.find( { _id: req.params.cargo_id }, { Cars: { $elemMatch: { _id: req.body.data.car_id } } } ,","//      function(err, cargos) {","//          console.log(cargos[0])","//         // cargos[0].Cars.push(car);","//         // cargos[0].save();","//         // return res.send(cargos);","//   });","","","","module.exports = router",""],"id":1}],[{"start":{"row":44,"column":0},"end":{"row":347,"column":0},"action":"remove","lines":["","","//CONSIGNEE","router.get('/cargo/displaynewcargo', function(req, res) {","    if (req.user) {","        //get clients","","        async.parallel([","","            function(callback) {","                Clients.find({}).sort('-_id').exec(function(err, foundData) {","                    callback(err, foundData);","                });","            }","","        ], (err, results) => {","            var clientsData = results[0];","            return res.render(\"main/newCargo\", { title: 'Oldsailor Ocean Shipping LLC || New Cargo', clientsData: clientsData, layout: false });","        });","","    }","    else {","        return res.redirect('/login');","    }","});","","","","//check per day","router.get(\"/checkcargourl__/:id\", function(req, res) {","    //  console.log(req.params.id);","    var date = new Date();","    date.setHours(0, 0, 0, 0)","    //console.log(date)","","    Cargos.findOne({ createdAt: date, Client: req.params.id }, function(err, foundData) {","        if (foundData) {","            //       console.log(\"here\")","            return res.send(foundData._id);","        }","        else {","            return res.send(\"\");","        }","","    });","});","","","","","router.post(\"/cargo/new\", function(req, res) {","    //check if cargo exist ","    //   var vin = \"\";","    var car = undefined;","    // if (req.body.data.vin !== \"\") {","    //     vin = req.body.data.vin;","    // }","","    if (req.body.data.cardetails !== \"\") {","        car = {","            vin: req.body.data.vin,","            aes: req.body.data.aes,","            cardetails: req.body.data.cardetails,","","","        }","    }","","","","    if (req.body.data.cargo_id === \"\") {","        //cargo does not exist add","","        var newData = {","            createdAt: moment.parseZone(new Date()).format('l'),","            Cars: car,","            Client: req.body.data.client_ID,","            personal_effect: req.body.data.personal_effect","        };","","        //add","        Cargos.create(newData, function(err, newlyCreated) {","            // console.log(newlyCreated);","            return res.send(newlyCreated);","        });","    }","    else {","        //cargo exist update","","        async.parallel([","            function(callback) {","                //update personal effect","                Cargos.findByIdAndUpdate(req.body.data.cargo_id, { personal_effect: req.body.data.personal_effect },","                    function(err, updatedData) {","                        callback(err, updatedData);","                    });","            },","            function(callback) {","                //push new cars into the array","                Cargos.findOne({ _id: req.body.data.cargo_id },","                    function(err, cargos) {","                        cargos.Cars.push(car);","                        cargos.save();","                        callback(err, cargos);","                    });","            }","        ], function(err, results) {","            var result1 = results[0];","            var cars = results[1];","            //console.log(result1.personal_effect);","            console.log(cars.Cars);","            return res.send(result1);","        });","","","    }","});","","","","//Add More Cars","router.post(\"/cargo/:id/addmorecars\", function(req, res) {","    //check if cargo exist ","    // var vin = \"\";","    // if (req.body.data.vin !== \"\") {","    //     vin = \"VIN:\" + req.body.data.vin;","    // }","","    //check for cardetails","","    var car = {","        vin: req.body.data.vin,","        aes: req.body.data.aes,","        cardetails: req.body.data.cardetails,","","","    }","    //update Cars Array","    //push new cars into the array","    Cargos.findOne({ _id: req.params.id },","        function(err, cargos) {","","            //check if there is a car before pushing","            if (req.body.data.cardetails !== \"\") {","                cargos.Cars.push(car);","                cargos.save();","                return res.send(cargos);","            }","            else {","                return res.send(false);","            }","","","        });","","});","","","//Fetch Cargo per client by name","router.get(\"/cargo/:value/fetchCargo_perclient\", function(req, res) {","    if (\"Display cargo per client\" === req.params.value) {","        Cargos","            .find({})","            .populate(\"Client\")","            .exec(function(err, foundAllData) {","                return res.send(foundAllData)","            });","","    }","    else {","        //get that clients cargos","","","        // console.log();","        Cargos","            .find({ Client: req.params.value })","            .populate('Client')","            .exec(function(err, foundData) {","                // console.log(foundData);","                return res.send(foundData)","","            });","","","    }","});","","","","//display one cargo","router.get('/cargo/:id/oneCargo', function(req, res) {","    if (req.user) {","        Cargos.findOne({ _id: req.params.id })","            .populate(\"Client\")","            .exec(function(err, foundData) {","                //console.log(foundData);","                res.send(foundData);","            });","","    }","    else {","        return res.redirect('/login');","    }","});","","","//display edit cargo route","router.get('/cargo/:id/editRoute', function(req, res) {","    if (req.user) {","        Cargos.findOne({ _id: req.params.id })","            .populate(\"Client\")","            .exec(function(err, foundData) {","                //console.log(foundData);","                res.render(\"main/editCargo\", { layout: false, foundData: foundData });","            });","","    }","    else {","        return res.redirect('/login');","    }","});","","//edit car post route","router.post(\"/cargo/:cargo_id/edit\", function(req, res) {","    Cargos.update({","            _id: req.params.cargo_id,","            Cars: { $elemMatch: { _id: req.body.data.car_id } }","        },","","        {","            $set: {","                \"Cars.$.cardetails\": req.body.data.cardetails,","                \"Cars.$.aes\": req.body.data.aes,","                \"Cars.$.vin\": req.body.data.vin","            },","","","        }, {","            \"multi\": true","","        },","        function(err, updated) {","            // console.log(updated)","            return res.send(updated)","        });","});","","//edit personal effect","router.post(\"/cargo/:cargo_id/edit_personaleffect\", function(req, res) {","    Cargos.findByIdAndUpdate(req.params.cargo_id, { personal_effect: req.body.data.personal_effect }, function(err, updatedData) {","        res.send(updatedData);","    });","});","","","//delete cargo","router.delete(\"/cargo/:id/delete\", function(req, res) {","    Cargos.findByIdAndRemove(req.params.id, function(err) {","        if (err)","            return console.log(err);","        else","            return res.send(req.params.id);","    })","","});","","","//delete Car","router.post(\"/cars/:car_id/delete/:cargo_id\", function(req, res) {","    Cargos.update({","            _id: req.params.cargo_id","","        }, {","            \"$pull\": {","                \"Cars\": {","                    \"_id\": req.params.car_id","                }","            }","        },","","        {","            safe: true,","            multi: true","        },","        function(err, updated) {","            // console.log(updated);","            res.send(updated)","        });","    // console.log(req.params.car_id);","});","","","","","","// Cargos.find( { _id: req.params.cargo_id }, { Cars: { $elemMatch: { _id: req.body.data.car_id } } } ,","//      function(err, cargos) {","//          console.log(cargos[0])","//         // cargos[0].Cars.push(car);","//         // cargos[0].save();","//         // return res.send(cargos);","//   });","",""],"id":2}],[{"start":{"row":11,"column":2},"end":{"row":11,"column":11},"action":"remove","lines":["CONSIGNEE"],"id":3}],[{"start":{"row":11,"column":2},"end":{"row":11,"column":3},"action":"insert","lines":["E"],"id":4},{"start":{"row":11,"column":3},"end":{"row":11,"column":4},"action":"insert","lines":["C"]},{"start":{"row":11,"column":4},"end":{"row":11,"column":5},"action":"insert","lines":["T"]},{"start":{"row":11,"column":5},"end":{"row":11,"column":6},"action":"insert","lines":["N"]}],[{"start":{"row":11,"column":6},"end":{"row":11,"column":7},"action":"insert","lines":[" "],"id":5},{"start":{"row":11,"column":7},"end":{"row":11,"column":8},"action":"insert","lines":["F"]},{"start":{"row":11,"column":8},"end":{"row":11,"column":9},"action":"insert","lines":["O"]},{"start":{"row":11,"column":9},"end":{"row":11,"column":10},"action":"insert","lines":["R"]},{"start":{"row":11,"column":10},"end":{"row":11,"column":11},"action":"insert","lines":["M"]}],[{"start":{"row":3,"column":0},"end":{"row":4,"column":0},"action":"insert","lines":["const Cargos = require(\"../models/cargo\");",""],"id":6}],[{"start":{"row":3,"column":0},"end":{"row":4,"column":0},"action":"remove","lines":["const Cargos = require(\"../models/cargo\");",""],"id":7}],[{"start":{"row":12,"column":13},"end":{"row":12,"column":18},"action":"remove","lines":["cargo"],"id":8},{"start":{"row":12,"column":13},"end":{"row":12,"column":14},"action":"insert","lines":["e"]},{"start":{"row":12,"column":14},"end":{"row":12,"column":15},"action":"insert","lines":["c"]},{"start":{"row":12,"column":15},"end":{"row":12,"column":16},"action":"insert","lines":["t"]},{"start":{"row":12,"column":16},"end":{"row":12,"column":17},"action":"insert","lines":["n"]}],[{"start":{"row":35,"column":36},"end":{"row":35,"column":41},"action":"remove","lines":["cargo"],"id":9},{"start":{"row":35,"column":36},"end":{"row":35,"column":37},"action":"insert","lines":["e"]},{"start":{"row":35,"column":37},"end":{"row":35,"column":38},"action":"insert","lines":["c"]},{"start":{"row":35,"column":38},"end":{"row":35,"column":39},"action":"insert","lines":["t"]},{"start":{"row":35,"column":39},"end":{"row":35,"column":40},"action":"insert","lines":["n"]},{"start":{"row":35,"column":40},"end":{"row":35,"column":41},"action":"insert","lines":["."]}],[{"start":{"row":35,"column":40},"end":{"row":35,"column":41},"action":"remove","lines":["."],"id":10}],[{"start":{"row":35,"column":85},"end":{"row":35,"column":90},"action":"remove","lines":["Cargo"],"id":11},{"start":{"row":35,"column":85},"end":{"row":35,"column":86},"action":"insert","lines":["E"]},{"start":{"row":35,"column":86},"end":{"row":35,"column":87},"action":"insert","lines":["C"]},{"start":{"row":35,"column":87},"end":{"row":35,"column":88},"action":"insert","lines":["T"]},{"start":{"row":35,"column":88},"end":{"row":35,"column":89},"action":"insert","lines":["N"]}]]},"ace":{"folds":[],"scrolltop":240,"scrollleft":0,"selection":{"start":{"row":35,"column":89},"end":{"row":35,"column":89},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":77,"mode":"ace/mode/javascript"}},"timestamp":1526533327452,"hash":"628f4955fb0bd5a68fd8d3c50e759f56da692dd5"}